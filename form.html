
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>找老師(資訊系新鮮人成長營 114)</title>
    <style><?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?></style>
    <!-- 移除舊的內嵌樣式，全面改用 Tailwind utilities -->
  </head>
  <body class="bg-gray-100 text-gray-800 antialiased min-h-screen py-4 px-4 md:px-6 text-[15px] md:text-base leading-6 font-normal">
    <div class="container max-w-md md:max-w-lg mx-auto">
      <h1 class="text-lg md:text-2xl font-semibold leading-tight tracking-tight mb-4">找老師 (資訊系新鮮人成長營 114)</h1>
      <div class="card bg-white border border-gray-200 rounded-lg p-5 md:p-6 shadow-sm">
        <form id="dreamForm" novalidate autocomplete="on">
        <label for="className" class="block mt-0 mb-1 text-sm font-medium">班級 Class</label>
        <select id="className" name="className" required class="block w-full box-border px-3 py-2 md:px-3.5 md:py-2.5 text-[15px] md:text-base border border-gray-300 rounded-md bg-white focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 shadow-sm">
          <option value="">請選擇 Select…</option>
          <option>資訊一甲</option>
          <option>資訊一乙</option>
          <option>資訊一丙</option>
        </select>

        <label for="studentId" class="block mt-3 mb-1 text-sm font-medium">學號 Student ID</label>
        <input type="text" id="studentId" name="studentId" required inputmode="numeric" autocomplete="on" class="block w-full box-border px-3 py-2 md:px-3.5 md:py-2.5 text-[15px] md:text-base border border-gray-300 rounded-md bg-white focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 shadow-sm" />

        <label for="name" class="block mt-3 mb-1 text-sm font-medium">姓名 Name</label>
        <input type="text" id="name" name="name" required autocomplete="name" class="block w-full box-border px-3 py-2 md:px-3.5 md:py-2.5 text-[15px] md:text-base border border-gray-300 rounded-md bg-white focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 shadow-sm" />

        <label for="dream" class="block mt-3 mb-1 text-sm font-medium">四年的學習，如果可以幫助你完成一個夢想，那會是什麼夢想? 請詳細說明<br /><span class="text-sm text-gray-500 font-normal">If four years of study could help you achieve one dream, what would it be? Please elaborate.</span></label>
        <textarea id="dream" name="dream" required class="block w-full box-border px-3 py-2 md:px-3.5 md:py-2.5 text-[15px] md:text-base border border-gray-300 rounded-md bg-white focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 shadow-sm min-h-[100px] md:min-h-[140px] resize-y"></textarea>

        <button class="btn block w-full box-border mt-4 py-2.5 md:py-3 text-[15px] md:text-base font-semibold text-white bg-blue-600 rounded-md disabled:opacity-70 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors shadow-sm" id="submitBtn" type="submit" data-idle="提交 Submit" data-busy="分析中… Analyzing…">提交 Submit</button>
        <div id="err" class="error text-red-600 mt-3 text-sm" role="alert" aria-live="assertive" style="display:none"></div>
        </form>
      </div>

      <div id="result" class="card bg-white border border-gray-200 rounded-lg p-5 md:p-6 shadow-sm mt-4" style="display:none" aria-live="polite"></div>
    </div>

    <script>
      (function() {
        const $ = (id) => document.getElementById(id);

        // 簡單本地儲存：避免重新整理遺失內容
        const FIELDS = ['className', 'studentId', 'name', 'dream'];
        function saveLocal(data) {
          try { localStorage.setItem('dreamForm', JSON.stringify(data)); } catch (e) {}
        }
        function loadLocal() {
          try {
            const raw = localStorage.getItem('dreamForm');
            return raw ? JSON.parse(raw) : null;
          } catch (e) { return null; }
        }

        function setLoading(loading) {
          const btn = $('submitBtn');
          btn.disabled = !!loading;
          btn.textContent = loading ? (btn.getAttribute('data-busy') || '分析中…') : (btn.getAttribute('data-idle') || '提交');
        }

        function showError(msg) {
          const el = $('err');
          el.textContent = msg || '未知錯誤';
          el.style.display = 'block';
        }
        function clearError() {
          const el = $('err');
          el.textContent = '';
          el.style.display = 'none';
        }

        function sanitizeURL(url) {
          try {
            const u = new URL(url);
            if (u.protocol === 'http:' || u.protocol === 'https:') return u.toString();
          } catch (e) {}
          return '';
        }

        function renderKV(label, valueNode) {
          const row = document.createElement('div');
          row.className = 'kv flex py-1 md:py-1.5 border-t border-gray-200 first:border-t-0';
          const k = document.createElement('div');
          k.className = 'k font-medium flex-none w-20 md:w-24 text-gray-500 text-sm';
          k.textContent = label;
          const v = document.createElement('div');
          v.className = 'v flex-1';
          if (typeof valueNode === 'string') {
            v.textContent = valueNode;
          } else if (valueNode) {
            v.appendChild(valueNode);
          }
          row.appendChild(k);
          row.appendChild(v);
          return row;
        }

        function renderResult(res) {
          const container = $('result');
          container.innerHTML = '';
          const title = document.createElement('div');
          title.className = 'result-title text-base md:text-lg font-semibold mb-2.5';
          title.textContent = '建議結果';
          container.appendChild(title);

          const teacher = (res && res.teacherName) ? res.teacherName : '（無）';
          const teacherTitle = (res && res.title) ? (' ' + res.title) : '';
          const reason = (res && res.reason) ? res.reason : '（無）';

          container.appendChild(renderKV('推薦你找', teacher + teacherTitle));
          container.appendChild(renderKV('推薦原因', reason));

          let webNode = document.createTextNode('（無）');
          if (res && res.web) {
            const safe = sanitizeURL(res.web);
            if (safe) {
              const a = document.createElement('a');
              a.href = safe;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.className = 'text-blue-600 break-all hover:underline';
              // 顯示人類可讀（解碼後）的中文字，但 href 維持編碼版本
              let label = safe;
              try { label = decodeURI(safe); } catch (e) { label = res.web; }
              a.textContent = label;
              webNode = a;
            }
          }
          container.appendChild(renderKV('老師網頁', webNode));

          container.style.display = 'block';
        }

        function getData() {
          return {
            className: $('className').value.trim(),
            studentId: $('studentId').value.trim(),
            name: $('name').value.trim(),
            dream: $('dream').value.trim()
          };
        }

        function validate(data) {
          if (!data.className || !data.studentId || !data.name || !data.dream) return '請完整填寫所有欄位';
          // 可選：學號僅數字/英數
          if (!/^[-A-Za-z0-9]+$/.test(data.studentId)) return '學號格式不正確（僅允許英數與連字號）';
          return '';
        }

        // 初始化：套入本地儲存
        document.addEventListener('DOMContentLoaded', function() {
          const saved = loadLocal();
          if (saved) {
            FIELDS.forEach((f) => { if ($(f) && saved[f]) $(f).value = saved[f]; });
          }
          // 欄位變更即保存
          FIELDS.forEach((f) => {
            const el = $(f);
            if (!el) return;
            el.addEventListener('input', () => saveLocal(getData()));
            el.addEventListener('change', () => saveLocal(getData()));
          });
        });

        // 送出處理
        $('dreamForm').addEventListener('submit', function (e) {
          e.preventDefault();
          clearError();
          $('result').style.display = 'none';

          const data = getData();
          const msg = validate(data);
          if (msg) {
            showError(msg);
            return;
          }

          setLoading(true);
          google.script.run
            .withSuccessHandler((res) => {
              setLoading(false);
              renderResult(res || {});
            })
            .withFailureHandler((err) => {
              setLoading(false);
              showError((err && err.message) ? err.message : String(err || '未知錯誤'));
            })
            .handleForm(data);
        });
      })();
    </script>
  </body>
  </html>
