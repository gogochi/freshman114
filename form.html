
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>找老師(資訊系新鮮人成長營 114)</title>
    <style><?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?></style>
    <style>
      /* ===== 基礎重置 ===== */
      *, *::before, *::after {
        box-sizing: border-box;
      }

      html {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        font-size: 16px;
      }

      /* ===== CSS 變數 ===== */
      :root {
        --space-2: 16px;
        --space-3: 20px;
        --space-4: 28px;
        --color-bg-page: #f3f4f6; /* 頁面背景色 */
        --color-bg-card: #ffffff; /* 卡片背景色 */
        --color-border: #d1d5db;   /* 邊框顏色 */
        --color-text-primary: #1f2937;
        --color-text-secondary: #6b7280;
        --color-accent: #2563eb;
        --color-error: #dc2626;
      }

      /* ===== 基礎布局 ===== */
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', Arial, sans-serif;
        font-size: 1rem;
        color: var(--color-text-primary);
        background-color: var(--color-bg-page);
        line-height: 1.6;
        margin: 0;
        padding: var(--space-3); /* 讓卡片與螢幕邊緣有間距 */
      }

      .container {
        max-width: 640px; /* 設定內容最大寬度 */
        margin: 0 auto;   /* 讓容器置中 */
      }

      /* ===== 標題樣式 ===== */
      h1 {
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0 0 var(--space-3);
        line-height: 1.3;
      }

      /* ===== 表單與結果卡片 ===== */
      .card {
        background-color: var(--color-bg-card);
        border: 1px solid var(--color-border);
        padding: var(--space-4);
        border-radius: 12px;
      }

      #result.card {
        margin-top: var(--space-3);
      }

      #dreamForm {
        border: none;
        padding: 0;
        margin: 0;
      }

      /* ===== 表單元素 ===== */
      label {
        display: block;
        margin: var(--space-2) 0 4px;
        font-weight: 600;
      }

      label:first-of-type {
        margin-top: 0;
      }

      select,
      input[type="text"],
      textarea {
        width: 100%;
        padding: 14px 16px;
        font-size: 1rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background-color: #fff; /* 確保背景是白色 */
        line-height: 1.4;
      }

      select:focus,
      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
      }

      textarea {
        min-height: 140px;
        resize: vertical;
      }

      .hint {
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        font-weight: normal;
      }

      /* ===== 按鈕樣式 ===== */
      .btn {
        display: block;
        width: 100%;
        margin-top: var(--space-3);
        padding: 16px;
        font-size: 1rem;
        font-weight: 600;
        color: white;
        background: var(--color-accent);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        min-height: 52px;
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      /* ===== 訊息 ===== */
      .error {
        color: var(--color-error);
        margin-top: var(--space-2);
      }

      /* ===== 無障礙 ===== */
      .visually-hidden {
        position: absolute !important;
        width: 1px; height: 1px;
        padding: 0; margin: -1px;
        overflow: hidden; clip: rect(0, 0, 0, 0);
        white-space: nowrap; border: 0;
      }

      /* ===== 結果區塊 ===== */
      #result .result-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: var(--space-2);
      }

      #result .kv {
        display: flex;
        padding: 8px 0;
        border-top: 1px solid #eee;
      }

      #result .kv:first-of-type {
        border-top: none;
      }

      #result .k {
        font-weight: 600;
        flex: 0 0 90px;
        color: var(--color-text-secondary);
      }

      #result .v a {
        color: var(--color-accent);
        word-break: break-all;
      }

    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 antialiased min-h-screen py-5 px-5">
    <div class="container max-w-xl mx-auto">
      <h1 class="text-2xl font-semibold leading-snug mb-5">找老師 (資訊系新鮮人成長營 114)</h1>
      <div class="card bg-white border border-gray-300 rounded-xl p-7 shadow-sm">
        <form id="dreamForm" novalidate autocomplete="on">
        <label for="className">班級 Class</label>
        <select id="className" name="className" required class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 shadow-sm">
          <option value="">請選擇 Select…</option>
          <option>資訊一甲</option>
          <option>資訊一乙</option>
          <option>資訊一丙</option>
        </select>

        <label for="studentId">學號 Student ID</label>
        <input type="text" id="studentId" name="studentId" required inputmode="numeric" autocomplete="on" class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 shadow-sm" />

        <label for="name">姓名 Name</label>
        <input type="text" id="name" name="name" required autocomplete="name" class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 shadow-sm" />

        <label for="dream">四年的學習，如果可以幫助你完成一個夢想，那會是什麼夢想? 請詳細說明<br /><span class="hint">If four years of study could help you achieve one dream, what would it be? Please elaborate.</span></label>
        <textarea id="dream" name="dream" required class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-200 shadow-sm min-h-[140px] resize-y"></textarea>

        <button class="btn w-full mt-5 py-4 text-base font-semibold text-white bg-blue-600 rounded-lg disabled:opacity-70 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors" id="submitBtn" type="submit" data-idle="提交 Submit" data-busy="分析中… Analyzing…">提交 Submit</button>
        <div id="err" class="error text-red-600 mt-4" role="alert" aria-live="assertive" style="display:none"></div>
        </form>
      </div>

      <div id="result" class="card bg-white border border-gray-300 rounded-xl p-7 shadow-sm mt-5" style="display:none" aria-live="polite"></div>
    </div>

    <script>
      (function() {
        const $ = (id) => document.getElementById(id);

        // 簡單本地儲存：避免重新整理遺失內容
        const FIELDS = ['className', 'studentId', 'name', 'dream'];
        function saveLocal(data) {
          try { localStorage.setItem('dreamForm', JSON.stringify(data)); } catch (e) {}
        }
        function loadLocal() {
          try {
            const raw = localStorage.getItem('dreamForm');
            return raw ? JSON.parse(raw) : null;
          } catch (e) { return null; }
        }

        function setLoading(loading) {
          const btn = $('submitBtn');
          btn.disabled = !!loading;
          btn.textContent = loading ? (btn.getAttribute('data-busy') || '分析中…') : (btn.getAttribute('data-idle') || '提交');
        }

        function showError(msg) {
          const el = $('err');
          el.textContent = msg || '未知錯誤';
          el.style.display = 'block';
        }
        function clearError() {
          const el = $('err');
          el.textContent = '';
          el.style.display = 'none';
        }

        function sanitizeURL(url) {
          try {
            const u = new URL(url);
            if (u.protocol === 'http:' || u.protocol === 'https:') return u.toString();
          } catch (e) {}
          return '';
        }

        function renderKV(label, valueNode) {
          const row = document.createElement('div');
          row.className = 'kv flex py-2 border-t border-gray-200 first:border-t-0';
          const k = document.createElement('div');
          k.className = 'k font-semibold flex-none w-24 text-gray-500';
          k.textContent = label;
          const v = document.createElement('div');
          v.className = 'v flex-1';
          if (typeof valueNode === 'string') {
            v.textContent = valueNode;
          } else if (valueNode) {
            v.appendChild(valueNode);
          }
          row.appendChild(k);
          row.appendChild(v);
          return row;
        }

        function renderResult(res) {
          const container = $('result');
          container.innerHTML = '';
          const title = document.createElement('div');
          title.className = 'result-title text-lg font-semibold mb-3';
          title.textContent = '建議結果';
          container.appendChild(title);

          const teacher = (res && res.teacherName) ? res.teacherName : '（無）';
          const reason = (res && res.reason) ? res.reason : '（無）';

          container.appendChild(renderKV('推薦你找', teacher));
          container.appendChild(renderKV('推薦原因', reason));

          let webNode = document.createTextNode('（無）');
          if (res && res.web) {
            const safe = sanitizeURL(res.web);
            if (safe) {
              const a = document.createElement('a');
              a.href = safe;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.className = 'text-blue-600 break-all hover:underline';
              a.textContent = safe;
              webNode = a;
            }
          }
          container.appendChild(renderKV('老師網頁', webNode));

          container.style.display = 'block';
        }

        function getData() {
          return {
            className: $('className').value.trim(),
            studentId: $('studentId').value.trim(),
            name: $('name').value.trim(),
            dream: $('dream').value.trim()
          };
        }

        function validate(data) {
          if (!data.className || !data.studentId || !data.name || !data.dream) return '請完整填寫所有欄位';
          // 可選：學號僅數字/英數
          if (!/^[-A-Za-z0-9]+$/.test(data.studentId)) return '學號格式不正確（僅允許英數與連字號）';
          return '';
        }

        // 初始化：套入本地儲存
        document.addEventListener('DOMContentLoaded', function() {
          const saved = loadLocal();
          if (saved) {
            FIELDS.forEach((f) => { if ($(f) && saved[f]) $(f).value = saved[f]; });
          }
          // 欄位變更即保存
          FIELDS.forEach((f) => {
            const el = $(f);
            if (!el) return;
            el.addEventListener('input', () => saveLocal(getData()));
            el.addEventListener('change', () => saveLocal(getData()));
          });
        });

        // 送出處理
        $('dreamForm').addEventListener('submit', function (e) {
          e.preventDefault();
          clearError();
          $('result').style.display = 'none';

          const data = getData();
          const msg = validate(data);
          if (msg) {
            showError(msg);
            return;
          }

          setLoading(true);
          google.script.run
            .withSuccessHandler((res) => {
              setLoading(false);
              renderResult(res || {});
            })
            .withFailureHandler((err) => {
              setLoading(false);
              showError((err && err.message) ? err.message : String(err || '未知錯誤'));
            })
            .handleForm(data);
        });
      })();
    </script>
  </body>
  </html>
