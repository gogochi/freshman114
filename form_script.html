(function () {
  'use strict';

  /** 常數與設定 */
  const FIELDS = ['className', 'studentId', 'name', 'dream'];

  // -------- DOM helpers --------
  const $ = (id) => document.getElementById(id);
  const Dom = {
    show: (el) => { if (el) el.style.display = 'block'; },
    hide: (el) => { if (el) el.style.display = 'none'; },
    text: (el, t) => { if (el) el.textContent = t; }
  };

  // -------- Local storage --------
  const Storage = {
    key: 'dreamForm',
    save(data) {
      try { localStorage.setItem(this.key, JSON.stringify(data)); } catch (e) {}
    },
    load() {
      try {
        const raw = localStorage.getItem(this.key);
        return raw ? JSON.parse(raw) : null;
      } catch (e) { return null; }
    }
  };

  /**
   * 簡易 debounce，降低 localStorage 寫入頻率
   */
  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  // -------- URL utils --------
  const URLUtil = {
    sanitize(url) {
      try {
        const u = new URL(url);
        if (u.protocol === 'http:' || u.protocol === 'https:') return u.toString();
      } catch (e) {}
      return '';
    },
    display(url) {
      try { return decodeURI(url); } catch (e) { return url; }
    }
  };

  // -------- UI state --------
  function setLoading(loading) {
    const btn = $('submitBtn');
    if (!btn) return;
    btn.disabled = !!loading;
    btn.textContent = loading ? (btn.getAttribute('data-busy') || '分析中…') : (btn.getAttribute('data-idle') || '提交');
    btn.setAttribute('aria-disabled', String(!!loading));
    const form = $('dreamForm');
    if (form) form.setAttribute('aria-busy', String(!!loading));
  }

  function showError(msg) {
    const el = $('err');
    Dom.text(el, msg || '未知錯誤');
    Dom.show(el);
  }

  function clearError() {
    const el = $('err');
    Dom.text(el, '');
    Dom.hide(el);
  }

  // -------- Rendering --------
  function kvRow(label, valueNode) {
    const row = document.createElement('div');
    row.className = 'kv flex py-1 md:py-1.5 border-t border-gray-200 first:border-t-0';
    const k = document.createElement('div');
    k.className = 'k font-medium flex-none w-20 md:w-24 text-gray-500 text-sm';
    k.textContent = label;
    const v = document.createElement('div');
    v.className = 'v flex-1';
    if (typeof valueNode === 'string') v.textContent = valueNode;
    else if (valueNode) v.appendChild(valueNode);
    row.appendChild(k);
    row.appendChild(v);
    return row;
  }

  function buildWebLink(url) {
    if (!url) return document.createTextNode('（無）');
    const safe = URLUtil.sanitize(url);
    if (!safe) return document.createTextNode('（無）');
    const a = document.createElement('a');
    a.href = safe;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.className = 'text-blue-600 break-all hover:underline';
    a.textContent = URLUtil.display(safe);
    return a;
  }

  function renderResult(res) {
    const container = $('result');
    if (!container) return;
    container.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'result-title text-base md:text-lg font-semibold mb-2.5';
    title.textContent = '建議結果';
    container.appendChild(title);

    const teacher = (res && res.teacherName) ? res.teacherName : '（無）';
    const teacherTitle = (res && res.title) ? (' ' + res.title) : '';
    const reason = (res && res.reason) ? res.reason : '（無）';

    container.appendChild(kvRow('推薦你找', teacher + teacherTitle));
    container.appendChild(kvRow('推薦原因', reason));

    container.appendChild(kvRow('老師網頁', buildWebLink(res && res.web)));

    Dom.show(container);
  }

  // -------- Validation & data --------
  function getData() {
    return {
      className: $('className')?.value.trim() || '',
      studentId: $('studentId')?.value.trim() || '',
      name: $('name')?.value.trim() || '',
      dream: $('dream')?.value.trim() || ''
    };
  }

  function validate(data) {
    // 僅在送出後由伺服器檢查學號；前端只檢查必填
    if (!data.className || !data.studentId || !data.name || !data.dream) return '請完整填寫所有欄位';
    return '';
  }

  // 已退回：前端不計算學號檢查碼

  // -------- Event wiring --------
  function restoreFromStorage() {
    const saved = Storage.load();
    if (!saved) return;
    FIELDS.forEach((f) => { const el = $(f); if (el && saved[f]) el.value = saved[f]; });
  }

  function bindAutosave() {
    const save = debounce(() => Storage.save(getData()), 200);
    FIELDS.forEach((f) => {
      const el = $(f);
      if (!el) return;
      el.addEventListener('input', save);
      el.addEventListener('change', save);
      // 任何輸入時清掉錯誤提示
      el.addEventListener('input', () => clearError());
    });
  }

  // -------- Server API（具名函式，async/await 友善） --------
  function handleFormAsync(data) {
    return new Promise((resolve, reject) => {
      try {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .handleForm(data);
      } catch (e) {
        reject(e);
      }
    });
  }

  async function onSubmit(e) {
    e.preventDefault();
    clearError();
    Dom.hide($('result'));

    const data = getData();
    const msg = validate(data);
    if (msg) { showError(msg); return; }

    setLoading(true);
    try {
      const res = await handleFormAsync(data);
      renderResult(res || {});
    } catch (err) {
      console.error(err);
      const msg = (err && err.message) ? err.message : String(err || '未知錯誤');
      showError(msg);
      // 若是學號錯誤，聚焦學號欄位提醒重新輸入
      if (/學號/.test(msg)) {
        const el = $('studentId');
        if (el) { el.focus(); el.select && el.select(); }
      }
    } finally {
      setLoading(false);
    }
  }

  function init() {
    restoreFromStorage();
    bindAutosave();
    const form = $('dreamForm');
    if (form) {
      form.addEventListener('submit', onSubmit, { passive: false });
      const btn = $('submitBtn');
      if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); onSubmit(e); }); // 後援
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    // DOM 已可操作，立即初始化（避免漏接 DOMContentLoaded 導致表單跳轉）
    init();
  }
})();
